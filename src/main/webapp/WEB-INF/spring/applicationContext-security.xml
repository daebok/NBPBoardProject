<beans:beans xmlns="http://www.springframework.org/schema/security"
	xmlns:beans="http://www.springframework.org/schema/beans" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:jee="http://www.springframework.org/schema/jee"
	xsi:schemaLocation="http://www.springframework.org/schema/security http://www.springframework.org/schema/security/spring-security-4.2.xsd
		http://www.springframework.org/schema/jee http://www.springframework.org/schema/jee/spring-jee-3.1.xsd
		http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.1.xsd">


	<http auto-config='true' use-expressions="true">
		<intercept-url pattern="/user/**" access="permitAll" /> <!-- 로그인 및 회원가입 모두 허용 -->
		<intercept-url pattern="/resources/**" access="permitAll" /> <!-- 리소스 모두 허용 -->
		<intercept-url pattern="/board" access="permitAll" />
		<intercept-url pattern="/board/**" access="isAuthenticated()" /> <!-- 나머지는 모두 권한이 있는 사람만 허용 -->
		<intercept-url pattern="/admin/**" access="hasRole('ROLE_ADMIN')" /> <!-- 관리자 페이지 -->

		<!-- 사용자이름과 비밀번호를 가지고있는 폼기반 인증방법 -->
		<form-login 
			username-parameter="userId" 
			password-parameter="userPassword"
			login-page="/user/loginPage" 
			default-target-url="/board"
			authentication-failure-url="/user/loginPage?error"
			login-processing-url="/loginProcess" />

		<!-- 중복 로그인 설정 -->
		<session-management>
			<!-- max-sessions: 중복 로그인 가능한 세션 수 (1로 지정해야 중복 로그인 막을 수 있다) -->
			<!-- expired-url: 중복 로그인이 발생하면, 먼저 로그인 한 세션이 끊어지게 된다. 세션이 끊어진 상태에서, 모든 
				url을 호출할 경우, 끊어진 원인을 알려줄 장소 지정 -->
			<concurrency-control 
				max-sessions="1"
				expired-url="/user/login/duplicate" />
		</session-management>

		<!-- 로그아웃되면 세션 초기화 -->
		<logout 
			delete-cookies="true" 
			invalidate-session="true"
			logout-url="/user/logout" 
			logout-success-url="/user/loginPage?logout" />

		<access-denied-handler ref="userDeniedHandler"/>
		
		<!-- 해킹을 막는다. -->
		<csrf />
	</http>
	
	<beans:bean id="userDeniedHandler" class="com.hyunhye.security.UserDeniedHandler"></beans:bean>
	<beans:bean id="userLoginSuccessHandler" class="com.hyunhye.security.UserLoginSuccessHandler"></beans:bean>
	<beans:bean id="userLoginFailureHandler" class="com.hyunhye.security.UserLoginFailureHandler"></beans:bean>
 
	<authentication-manager>
		<authentication-provider user-service-ref="userServiceManager">
		<password-encoder ref="passwordEncoder"/>
		</authentication-provider>
	</authentication-manager>
	
	<beans:bean id="userServiceManager" class="com.hyunhye.security.UserAuthenticationService">
	</beans:bean> 

	<beans:bean id="passwordEncoder"
		class="org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder">
	</beans:bean>
</beans:beans>
