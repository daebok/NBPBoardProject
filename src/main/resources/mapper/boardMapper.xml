<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.hyunhye.board.repository.BoardRepository">

	<resultMap id="boardList" type="board">
		<result property="userNo" column="user_no" />
		<result property="userId" column="user_id" />
		<result property="userName" column="user_name" />
		<result property="categoryNo" column="category_no" />
		<result property="categoryItem" column="category_item" />
		<result property="boardNo" column="board_no" />
		<result property="boardTitle" column="board_title" />
		<result property="boardContent" column="board_content" />
		<result property="boardDate" column="board_date"/>
		<result property="boardViewCount" column="board_view_cnt" />
		<result property="commentCount" column="comment_count" />
	</resultMap>
	
	<resultMap id="categoryList" type="category">
		<result property="categoryNo" column="category_no" />
		<result property="categoryItem" column="category_item" />
	</resultMap>


	<resultMap id="fileList" type="file">
		<result property="boardNo" column="board_no" />
		<result property="fileNo" column="file_no" />
		<result property="fileName" column="file_name" />
		<result property="fileOriginName" column="file_origin_name" />
		<result property="fileExtension" column="file_extension" />
	</resultMap>
	
	<insert id="addFile">
		INSERT INTO FILE (
			board_no, 
			file_name, 
			file_origin_name, 
			file_extension
		) VALUES ( 
			(SELECT board_no FROM BOARD ORDER BY board_no desc limit 1), 
			#{fileName}, 
			#{fileOriginName}, 
			#{fileExtension} 
		)
	</insert>
	
	<select id="getFile" resultMap="fileList">
		SELECT 
			file_no, 
			file_name, 
			file_origin_name 
		FROM FILE 
		WHERE 
			board_no = #{boardNo}; 
	</select>
	
	<delete id="deleteFile">
		DELETE FROM FILE 
		WHERE 
			file_no = #{fileNo}
	</delete>
	
	<select id="categoryListAll" resultMap="categoryList">
		SELECT category_item
		FROM CATEGORY
	</select>

	<select id="boardListAll" resultMap="boardList">
		<include refid='selectBoard'></include>
		<include refid="join_category"></include>
		<include refid="join_user"></include>
		<include refid="left_join_comment"></include>
		group by board_no
		ORDER BY BOARD.board_view_cnt desc
		limit 0, 10
	</select>

	<insert id="boardRegist">
		INSERT INTO BOARD (
			user_no, 
			category_no, 
			board_title, 
			board_content
		) VALUES (
			#{userNo}, 
			(SELECT category_no FROM CATEGORY WHERE category_item = #{categoryItem}), 
			#{boardTitle}, 
			#{boardContent}
		)
	</insert>

	<select id="boardSelect" resultMap="boardList">
		SELECT 
			BOARD.board_no, 
			BOARD.user_no, 
			USER.user_name, 
			USER.user_id,
			CATEGORY.category_item, 
			BOARD.board_title, 
			BOARD.board_content, 
			BOARD.board_date,
			BOARD.board_view_cnt
		FROM BOARD 
		<include refid="join_category"></include>
		<include refid="join_user"></include>
		WHERE 
			board_no = #{boardNo}
	</select>

	<select id="boardModify" resultMap="boardList">
		UPDATE BOARD SET
			board_title = #{boardTitle},
			board_content = #{boardContent},
			board_date = #{boardDate}
		WHERE 
			board_no = #{boardNo}
	</select>

	<delete id="boardDelete"> 
		DELETE FROM BOARD 
		WHERE 
			board_no = #{boardNo} 
	</delete>
	
	<select id="listCriteria" resultMap="boardList">
		<include refid='selectBoard'></include>
		<include refid="join_category"></include>
		<include refid="join_user"></include>
		<include refid="left_join_comment"></include>
		<if test="searchType != '' or categoryType != '' ">
			<include refid="search"></include>
		</if>
		group by board_no
		ORDER BY BOARD.board_no desc, BOARD.board_date desc
		limit #{startBoardNo}, #{perPageNum}
	</select>
	
	<select id="selectMyQuestions" resultMap="boardList">
		<include refid='selectBoard'></include>
		<include refid="join_category"></include>
		<include refid="join_user"></include>
		<include refid="left_join_comment"></include>
		<if test="searchType != '' or categoryType != '' ">
			<include refid="search"></include>
		</if>
		AND 
			BOARD.user_id = #{userId}
		group by board_no
		ORDER BY BOARD.board_no desc, BOARD.board_date desc
		limit #{startBoardNo}, #{perPageNum}
	</select>
	
	<select id="countPaging" resultType="int">
		SELECT COUNT(board_no) 
		FROM BOARD
		<include refid="join_category"></include>
		<if test="searchType != '' or categoryType != '' ">
			<include refid="search"></include>
		</if>
	</select>
	
	<select id="checkUser" resultType="int">
		SELECT 
			user_no 
		FROM BOARD
		WHERE 
			board_no = #{boardNo}
	</select>
	
	<update id="increaseViewCount">
		UPDATE BOARD SET 
			board_view_cnt = board_view_cnt + 1 
		WHERE 
			board_no = #{boardNo}
    </update>
    
	<sql id="search">
		<if test="categoryType != 'null'">
			WHERE CATEGORY.category_item = #{categoryType}
		</if>
		<if test="searchType != 'null'">
			AND 
			<choose>
				<when test="searchType == 'title_content'">
					( board_content like CONCAT('%',#{keyword},'%')
					OR board_title like CONCAT('%',#{keyword},'%') )
				</when>
				<when test="searchType == 'content'">
					 board_content like CONCAT('%',#{keyword},'%')
				</when>
				<when test="searchType == 'title'">
					 board_title like CONCAT('%',#{keyword},'%')
				</when>
			</choose>
		</if>
	</sql>
	
	<sql id="selectBoard">
		SELECT 
			BOARD.board_no, 
			USER.user_name, 
			CATEGORY.category_item, 
			BOARD.board_title, 
			BOARD.board_content, 
			BOARD.board_date, 
			BOARD.board_view_cnt,
			count(comment_no) as comment_count
		FROM BOARD
	</sql>
	
	<sql id="join_user">
		JOIN  USER
		ON BOARD.user_no = USER.user_no
	</sql>
	
	<sql id="join_category">
		JOIN CATEGORY
		ON BOARD.category_no = CATEGORY.category_no
	</sql>
	
	<sql id="left_join_comment">
		LEFT JOIN COMMENT
		ON BOARD.board_no = COMMENT.board_no
	</sql>
	
</mapper>
