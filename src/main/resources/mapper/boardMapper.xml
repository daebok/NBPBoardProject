<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.hyunhye.board.repository.BoardRepository">

	<resultMap id="boardList" type="board">
		<result property="userNo" column="user_no" />
		<result property="userId" column="user_id" />
		<result property="userName" column="user_name" />
		<result property="categoryNo" column="category_no" />
		<result property="categoryItem" column="category_item" />
		<result property="boardNo" column="board_no" />
		<result property="boardTitle" column="board_title" />
		<result property="boardContent" column="board_content" />
		<result property="boardDate" column="board_date"/>
		<result property="boardViewCount" column="board_view_cnt" />
		<result property="boardContentSummary" column="board_content_summary" />
		<result property="commentCount" column="comment_count" />
		<result property="fileCount" column="file_count" />
		<result property="bookmarkCheck" column="bookmark_check" />
	</resultMap>
	
	<resultMap id="categoryList" type="category">
		<result property="categoryNo" column="category_no" />
		<result property="categoryItem" column="category_item" />
		<result property="categoryEnabled" column="category_enabled" />
	</resultMap>
	
	<resultMap id="bookmarkList" type="bookmark">
		<result property="boardNo" column="board_no" />
		<result property="userNo" column="user_no" />
		<result property="bookmarkNo" column="bookmark_no" />
		<result property="bookmarkMemo" column="bookmark_memo" />
	</resultMap>


	<resultMap id="fileList" type="file">
		<result property="boardNo" column="board_no" />
		<result property="fileNo" column="file_no" />
		<result property="fileName" column="file_name" />
		<result property="fileOriginName" column="file_origin_name" />
		<result property="fileExtension" column="file_extension" />
		<result property="fileSize" column="file_size" />
	</resultMap>
	
	<insert id="addFile">
		INSERT INTO FILE (
			board_no, 
			file_name, 
			file_origin_name, 
			file_extension,
			file_size
		) VALUES ( 
			(SELECT board_no FROM BOARD ORDER BY board_no desc limit 1), 
			#{fileName}, 
			#{fileOriginName}, 
			#{fileExtension}, 
			#{fileSize} 
		)
	</insert>
	
	<select id="getFile" resultMap="fileList">
		SELECT 
			file_no, 
			file_name, 
			file_origin_name,
			file_size
		FROM FILE 
		WHERE 
			board_no = #{boardNo}; 
	</select>
	
	<delete id="deleteFile">
		DELETE FROM FILE 
		WHERE 
			file_name = #{fileDelete}
	</delete>
	
	<select id="categoryListAll" resultMap="categoryList">
		SELECT 
			category_item,
			category_no
		FROM CATEGORY
		WHERE category_enabled = 1
	</select>

	<select id="boardListAll" resultMap="boardList">
		SELECT 
			B.board_no,
			B.board_no as number, 
			USER.user_name, 
			CATEGORY.category_item, 
			B.category_no,
			B.board_title, 
			B.board_content_summary, 
			B.board_date, 
			B.board_view_cnt,
			(SELECT count(comment_no) FROM COMMENT WHERE COMMENT.comment_parent_no = 0 AND COMMENT.board_no = number) as comment_count,
			count(file_no) as file_count
		FROM (
				SELECT 
					BOARD.board_no, BOARD.user_no, BOARD.category_no, BOARD.board_title, 
					BOARD.board_content_summary, BOARD.board_date, BOARD.board_view_cnt, BOARD.board_content
				FROM BOARD 
				ORDER BY BOARD.board_view_cnt desc 
				LIMIT 0, 10
			) B
		JOIN CATEGORY
			ON B.category_no = CATEGORY.category_no
		JOIN USER
			ON B.user_no = USER.user_no
		LEFT JOIN FILE
			ON B.board_no = FILE.board_no
		GROUP BY B.board_no
		ORDER BY B.board_view_cnt desc
	</select>
	
	<select id="boardListNewest" resultMap="boardList">
		SELECT 
			B.board_no,
			B.board_no as number, 
			USER.user_name, 
			CATEGORY.category_item, 
			B.category_no,
			B.board_title, 
			B.board_content_summary, 
			B.board_date, 
			B.board_view_cnt,
			(SELECT count(comment_no) FROM COMMENT WHERE COMMENT.comment_parent_no = 0 AND COMMENT.board_no = number) as comment_count,
			count(file_no) as file_count
		FROM (
				SELECT 
					BOARD.board_no, BOARD.user_no, BOARD.category_no, BOARD.board_title, 
					BOARD.board_content_summary, BOARD.board_date, BOARD.board_view_cnt, BOARD.board_content
				FROM BOARD 
				ORDER BY BOARD.board_no desc 
				LIMIT 0, 10
			) B
		JOIN CATEGORY
			ON B.category_no = CATEGORY.category_no
		JOIN USER
			ON B.user_no = USER.user_no
		LEFT JOIN FILE
			ON B.board_no = FILE.board_no
		GROUP BY B.board_no
		ORDER BY B.board_no desc
	</select>
	
	<select id="boardListTopAnswers" resultMap="boardList">
		SELECT 
			B.board_no,
			USER.user_name, 
			CATEGORY.category_item, 
			B.category_no,
			B.board_title, 
			B.board_content_summary, 
			B.board_date, 
			B.board_view_cnt,
			B.comment_count,
			count(FILE.file_no) as file_count
		FROM (
				SELECT 
					BOARD.board_no, BOARD.board_no as number, BOARD.user_no, BOARD.category_no, BOARD.board_title, 
					BOARD.board_content_summary, BOARD.board_date, BOARD.board_view_cnt, BOARD.board_content,
					(SELECT count(comment_no) FROM COMMENT WHERE COMMENT.comment_parent_no = 0 AND COMMENT.board_no = number) as comment_count
				FROM BOARD 
				ORDER BY comment_count desc 
				LIMIT 0, 10
			) B
		JOIN CATEGORY
			ON B.category_no = CATEGORY.category_no
		JOIN USER
			ON B.user_no = USER.user_no
		LEFT JOIN FILE
			ON B.board_no = FILE.board_no
		GROUP BY B.board_no
		ORDER BY B.comment_count desc;
	</select>

	<insert id="boardRegist">
		INSERT INTO BOARD (
			user_no, 
			category_no, 
			board_title, 
			board_content,
			board_content_summary
		) VALUES (
			#{userNo}, 
			#{categoryNo},
			#{boardTitle}, 
			#{boardContent},
			#{boardContentSummary}
		)
	</insert>
	
	<update id="bookMarkMemoRegist">
		UPDATE BOOKMARK
		SET 
			bookmark_memo = #{bookmarkMemo}
		WHERE
			board_no = #{boardNo}
			AND
			user_no = #{userNo}
	</update>
	
	<insert id="boardBookMark">
		INSERT INTO BOOKMARK (
			user_no,
			board_no
		) VALUES (
			#{userNo},
			#{boardNo}
		)
	</insert>
	
	<delete id="boardBookMarkUnCheck">
		DELETE FROM BOOKMARK 
		WHERE
			user_no = #{userNo}
			AND
			board_no =#{boardNo}
	</delete>
	
	<select id="boardBookMarkSelect">
		SELECT 
			count(bookmark_no)
		FROM BOOKMARK
		WHERE
			board_no = #{boardNo}
			AND
			user_no = #{userNo}
	</select>
	
	<select id="memoSelect" resultMap="bookmarkList">
		SELECT
			bookmark_memo
		FROM
			BOOKMARK
		WHERE
			user_no = #{userNo}
			AND
			board_no = #{boardNo}
	</select>

	<select id="boardSelect" resultMap="boardList">
		SELECT 
			BOARD.board_no, 
			BOARD.user_no, 
			USER.user_name, 
			USER.user_id,
			CATEGORY.category_item,
			BOARD.category_no,  
			BOARD.board_title, 
			BOARD.board_content, 
			BOARD.board_date,
			BOARD.board_view_cnt,
			(SELECT 1 FROM BOARD.BOOKMARK WHERE BOOKMARK.user_no = #{userNo} AND BOOKMARK.board_no = #{boardNo}) as bookmark_check
		FROM BOARD 
		<include refid="join_category"></include>
		<include refid="join_user"></include>
		<include refid="left_join_bookmark"></include>
		WHERE 
			BOARD.board_no = #{boardNo}
	</select>

	<select id="boardModify" resultMap="boardList">
		UPDATE BOARD SET
			board_title = #{boardTitle},
			board_content = #{boardContent},
			board_date = #{boardDate},
			category_no = #{categoryNo}
		WHERE 
			board_no = #{boardNo}
	</select>

	<delete id="boardDelete"> 
		DELETE FROM BOARD 
		WHERE 
			board_no = #{boardNo} 
	</delete>
	
	<select id="listCriteria" resultMap="boardList">
		SELECT 
			B.board_no, 
			B.board_no as number,
			USER.user_name, 
			CATEGORY.category_item, 
			B.category_no,
			B.board_title, 
			B.board_content_summary, 
			B.board_date, 
			B.board_view_cnt,
			(SELECT count(comment_no) FROM COMMENT WHERE COMMENT.comment_parent_no = 0 AND COMMENT.board_no = number) as comment_count,
			count(file_no) as file_count
		FROM (
				SELECT 
					BOARD.board_no, BOARD.user_no, BOARD.category_no, BOARD.board_title, BOARD.board_content_summary, 
					BOARD.board_date, BOARD.board_view_cnt, BOARD.board_content
				FROM BOARD
				<if test="categoryType != '' ">
					WHERE
					<include refid="category_search"></include>
				</if>
				<if test="searchType != '' ">
					<if test="categoryType != '' ">
						AND
					</if>
					<if test="categoryType == '' ">
						WHERE
					</if>
					<include refid="search_search"></include>
				</if> 
				ORDER BY BOARD.board_no desc 
				LIMIT #{startBoardNo}, #{perPageNum}
			) B
		JOIN CATEGORY
			ON B.category_no = CATEGORY.category_no
		JOIN USER
			ON B.user_no = USER.user_no
		LEFT JOIN FILE
			ON B.board_no = FILE.board_no
		GROUP BY B.board_no
		ORDER BY B.board_no desc
	</select>
	
	<select id="selectMyQuestions" resultMap="boardList">
		SELECT 
			B.board_no,
			B.board_no as number,
			CATEGORY.category_item, 
			B.category_no,
			B.board_title, 
			B.board_content_summary, 
			B.board_date, 
			B.board_view_cnt,
			(SELECT count(comment_no) FROM COMMENT WHERE COMMENT.comment_parent_no = 0 AND COMMENT.board_no = number) as comment_count,
			count(file_no) as file_count
		FROM (
				SELECT 
					BOARD.board_no, BOARD.user_no, BOARD.category_no, BOARD.board_title, BOARD.board_content_summary, 
					BOARD.board_date, BOARD.board_view_cnt, BOARD.board_content
				FROM BOARD
				WHERE BOARD.user_no = #{userNo} 
				ORDER BY BOARD.board_no desc 
				LIMIT #{startBoardNo}, #{perPageNum}
			) B
		JOIN CATEGORY
			ON B.category_no = CATEGORY.category_no
		LEFT JOIN FILE
			ON B.board_no = FILE.board_no
		GROUP BY B.board_no
		ORDER BY B.board_no desc
	</select>
	
	<select id="selectMyFavorite" resultMap="boardList">
		SELECT 
			B.board_no,
			B.board_no as number, 
			USER.user_name, 
			CATEGORY.category_item, 
			B.category_no,
			B.board_title, 
			B.board_content_summary, 
			B.board_date, 
			B.board_view_cnt,
			(SELECT count(comment_no) FROM COMMENT WHERE COMMENT.comment_parent_no = 0 AND COMMENT.board_no = number) as comment_count,
			count(file_no) as file_count
		FROM (
				SELECT 
					BOARD.board_no, BOARD.user_no, BOARD.category_no, BOARD.board_title, BOARD.board_content_summary, 
					BOARD.board_date, BOARD.board_view_cnt, BOARD.board_content
				FROM BOARD
				JOIN BOOKMARK
					ON BOARD.board_no = BOOKMARK.board_no
				WHERE BOOKMARK.user_no = #{userNo} 
				ORDER BY BOARD.board_no desc 
				LIMIT #{startBoardNo}, #{perPageNum}
			) B
		JOIN CATEGORY
			ON B.category_no = CATEGORY.category_no
		JOIN USER
			ON B.user_no = USER.user_no
		LEFT JOIN FILE
			ON B.board_no = FILE.board_no
		GROUP BY B.board_no
		ORDER BY B.board_no desc
	</select>
	
	<select id="countMyQuestionsPaging" resultType="int">
		SELECT COUNT(board_no) 
		FROM BOARD
		WHERE
			BOARD.user_no = #{userNo} 
	</select>
	
	<select id="countMyFavoritePaging" resultType="int">
		SELECT COUNT(BOOKMARK.board_no) 
		FROM BOOKMARK
		WHERE
			BOOKMARK.user_no = #{userNo}
	</select>
	
	<select id="countPaging" resultType="int">
		SELECT COUNT(board_no) 
		FROM BOARD
		<include refid="join_category"></include>
		<if test="categoryType != '' ">
			WHERE
			<include refid="category_search"></include>
		</if>
		<if test="searchType != '' ">
			<if test="categoryType != '' ">
				AND
			</if>
			<if test="categoryType == '' ">
				WHERE
			</if>
			<include refid="search_search"></include>
		</if>
	</select>
	
	<select id="checkUser" resultType="int">
		SELECT 
			user_no 
		FROM BOARD
		WHERE 
			board_no = #{boardNo}
	</select>
	
	<update id="increaseViewCount">
		UPDATE BOARD SET 
			board_view_cnt = board_view_cnt + 1 
		WHERE 
			board_no = #{boardNo}
	</update>

	<sql id="category_search">
		CATEGORY.category_item = #{categoryType}
	</sql>
	
	<sql id="search_search">
		<choose>
			<when test="searchType == 'title_content'">
				( board_content like CONCAT('%',#{keyword},'%')
				OR board_title like CONCAT('%',#{keyword},'%') )
			</when>
			<when test="searchType == 'content'">
				 board_content like CONCAT('%',#{keyword},'%')
			</when>
			<when test="searchType == 'title'">
				 board_title like CONCAT('%',#{keyword},'%') 
			</when>
		</choose>
	</sql>
	
	<sql id="join_user">
		JOIN  USER
		ON BOARD.user_no = USER.user_no
	</sql>
	
	<sql id="join_category">
		JOIN CATEGORY
		ON BOARD.category_no = CATEGORY.category_no
	</sql>
	
	<sql id="left_join_bookmark">
		LEFT JOIN BOARD.BOOKMARK
		ON BOARD.board_no = BOOKMARK.board_no
	</sql>
</mapper>
