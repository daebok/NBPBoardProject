<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.hyunhye.board.repository.BoardRepository">

	<resultMap id="boardList" type="board">
		<result property="userNo" column="user_no" />
		<result property="userId" column="user_id" />
		<result property="userName" column="user_name" />
		<result property="categoryNo" column="category_no" />
		<result property="categoryItem" column="category_item" />
		<result property="boardNo" column="board_no" />
		<result property="boardTitle" column="board_title" />
		<result property="boardContent" column="board_content" />
		<result property="boardDate" column="board_date"/>
		<result property="boardViewCount" column="board_view_cnt" />
		<result property="boardContentSummary" column="board_content_summary" />
		<result property="commentCount" column="comment_count" />
		<result property="fileCount" column="file_count" />
		<result property="bookmarkCheck" column="bookmark_check" />
	</resultMap>
	
	<resultMap id="categoryList" type="category">
		<result property="categoryNo" column="category_no" />
		<result property="categoryItem" column="category_item" />
		<result property="categoryEnabled" column="category_enabled" />
	</resultMap>
	
	<resultMap id="bookmarkList" type="bookmark">
		<result property="boardNo" column="board_no" />
		<result property="userNo" column="user_no" />
		<result property="bookmarkNo" column="bookmark_no" />
		<result property="bookmarkMemo" column="bookmark_memo" />
	</resultMap>


	<resultMap id="fileList" type="file">
		<result property="boardNo" column="board_no" />
		<result property="fileNo" column="file_no" />
		<result property="fileName" column="file_name" />
		<result property="fileOriginName" column="file_origin_name" />
		<result property="fileExtension" column="file_extension" />
		<result property="fileSize" column="file_size" />
	</resultMap>
	
	<!-- 첨부파일 -->
	<insert id="addFile">
		INSERT INTO FILE (
			board_no, 
			file_name, 
			file_origin_name, 
			file_extension,
			file_size
		) VALUES ( 
			(SELECT board_no FROM BOARD ORDER BY board_no desc limit 1), 
			#{fileName}, 
			#{fileOriginName}, 
			#{fileExtension}, 
			#{fileSize} 
		)
	</insert>
	
	<select id="getFile" resultMap="fileList">
		SELECT 
			file_no, 
			file_name, 
			file_origin_name,
			file_size
		FROM FILE 
		WHERE 
			board_no = #{boardNo}; 
	</select>
	
	<delete id="deleteFile">
		DELETE FROM FILE 
		WHERE 
			file_name = #{fileDelete}
	</delete>
	
	<select id="fileSelect" resultMap="fileList">
		SELECT 
			file_no,
			file_name,
			file_origin_name
		FROM FILE
		WHERE
			board_no = #{boardNo}
	</select>
	
	<!-- 카테고리 리스트 -->
	<select id="categoryListAll" resultMap="categoryList">
		SELECT 
			category_item,
			category_no
		FROM CATEGORY
		WHERE category_enabled = 1
	</select>

	<!-- 홈 화면에 보여줄 게시글 리스트 -->	
	<!-- 1. 조회수 순 -->
	<select id="boardListViews" resultMap="boardList">
		SELECT 
			B.board_no,
			B.board_no as number, 
			USER.user_name, 
			CATEGORY.category_item, 
			B.category_no,
			B.board_title, 
			B.board_content_summary, 
			B.board_date, 
			B.board_view_cnt,
			(SELECT count(comment_no) FROM COMMENT WHERE COMMENT.comment_parent_no = 0 AND COMMENT.board_no = number) as comment_count,
			count(file_no) as file_count
		FROM (
				SELECT 
					BOARD.board_no, BOARD.user_no, BOARD.category_no, BOARD.board_title, 
					BOARD.board_content_summary, BOARD.board_date, BOARD.board_view_cnt, BOARD.board_content
				FROM BOARD 
				ORDER BY BOARD.board_view_cnt desc 
				LIMIT 0, 10
			) B
		JOIN CATEGORY
			ON B.category_no = CATEGORY.category_no
		JOIN USER
			ON B.user_no = USER.user_no
		LEFT JOIN FILE
			ON B.board_no = FILE.board_no
		GROUP BY B.board_no
		ORDER BY B.board_view_cnt desc
	</select>
	
	<!-- 2. 최신 순 -->
	<select id="boardListNewest" resultMap="boardList">
		SELECT 
			B.board_no,
			B.board_no as number, 
			USER.user_name, 
			CATEGORY.category_item, 
			B.category_no,
			B.board_title, 
			B.board_content_summary, 
			B.board_date, 
			B.board_view_cnt,
			(SELECT count(comment_no) FROM COMMENT WHERE COMMENT.comment_parent_no = 0 AND COMMENT.board_no = number) as comment_count,
			count(file_no) as file_count
		FROM (
				SELECT 
					BOARD.board_no, BOARD.user_no, BOARD.category_no, BOARD.board_title, 
					BOARD.board_content_summary, BOARD.board_date, BOARD.board_view_cnt, BOARD.board_content
				FROM BOARD 
				ORDER BY BOARD.board_no desc 
				LIMIT 0, 10
			) B
		JOIN CATEGORY
			ON B.category_no = CATEGORY.category_no
		JOIN USER
			ON B.user_no = USER.user_no
		LEFT JOIN FILE
			ON B.board_no = FILE.board_no
		GROUP BY B.board_no
		ORDER BY B.board_no desc
	</select>
	
	<!-- 3. 답변 순 -->
	<select id="boardListTopAnswers" resultMap="boardList">
		SELECT 
			B.board_no,
			USER.user_name, 
			CATEGORY.category_item, 
			B.category_no,
			B.board_title, 
			B.board_content_summary, 
			B.board_date, 
			B.board_view_cnt,
			B.comment_count,
			count(FILE.file_no) as file_count
		FROM (
				SELECT 
					BOARD.board_no, BOARD.board_no as number, BOARD.user_no, BOARD.category_no, BOARD.board_title, 
					BOARD.board_content_summary, BOARD.board_date, BOARD.board_view_cnt, BOARD.board_content,
					(SELECT count(comment_no) FROM COMMENT WHERE COMMENT.comment_parent_no = 0 AND COMMENT.board_no = number) as comment_count
				FROM BOARD 
				ORDER BY comment_count desc 
				LIMIT 0, 10
			) B
		JOIN CATEGORY
			ON B.category_no = CATEGORY.category_no
		JOIN USER
			ON B.user_no = USER.user_no
		LEFT JOIN FILE
			ON B.board_no = FILE.board_no
		GROUP BY B.board_no
		ORDER BY B.comment_count desc;
	</select>

	<!-- 게시글 등록  -->
	<insert id="boardRegist">
		INSERT INTO BOARD (
			user_no, 
			category_no, 
			board_title, 
			board_content,
			board_content_summary
		) VALUES (
			#{userNo}, 
			#{categoryNo},
			#{boardTitle}, 
			#{boardContent},
			#{boardContentSummary}
		)
	</insert>

	<!-- 게시글 상세 보기 -->
	<select id="boardSelect" resultMap="boardList">
		SELECT 
			BOARD.board_no, 
			BOARD.user_no, 
			USER.user_name, 
			USER.user_id,
			CATEGORY.category_item,
			BOARD.category_no,  
			BOARD.board_title, 
			BOARD.board_content, 
			BOARD.board_date,
			BOARD.board_view_cnt,
			(SELECT 1 FROM BOARD.BOOKMARK WHERE BOOKMARK.user_no = #{userNo} AND BOOKMARK.board_no = #{boardNo}) as bookmark_check
		FROM BOARD 
		JOIN CATEGORY
			ON BOARD.category_no = CATEGORY.category_no
		JOIN  USER
			ON BOARD.user_no = USER.user_no
		LEFT JOIN BOARD.BOOKMARK
			ON BOARD.board_no = BOOKMARK.board_no
		WHERE 
			BOARD.board_no = #{boardNo}
	</select>

	<!-- 게시글 수정 -->
	<select id="boardModify" resultMap="boardList">
		UPDATE BOARD SET
			board_title = #{boardTitle},
			board_content = #{boardContent},
			category_no = #{categoryNo},
			board_content_summary = #{boardContentSummary}
		WHERE 
			board_no = #{boardNo}
	</select>

	<!-- 게시글 삭제 -->
	<delete id="boardDelete"> 
		DELETE FROM BOARD 
		WHERE 
			board_no = #{boardNo} 
	</delete>

	<!-- 즐겨찾기 -->
	<update id="bookMarkMemoRegist">
		UPDATE BOOKMARK
		SET 
			bookmark_memo = #{bookmarkMemo}
		WHERE
			board_no = #{boardNo}
			AND
			user_no = #{userNo}
	</update>
	
	<insert id="boardBookMark">
		INSERT INTO BOOKMARK (
			user_no,
			board_no
		) VALUES (
			#{userNo},
			#{boardNo}
		)
	</insert>
	
	<delete id="boardBookMarkUnCheck">
		DELETE FROM BOOKMARK 
		WHERE
			user_no = #{userNo}
			AND
			board_no =#{boardNo}
	</delete>
	
	<select id="boardBookMarkSelect">
		SELECT 
			count(bookmark_no)
		FROM BOOKMARK
		WHERE
			board_no = #{boardNo}
			AND
			user_no = #{userNo}
	</select>
	
	<select id="memoSelect" resultMap="bookmarkList">
		SELECT
			bookmark_memo
		FROM
			BOOKMARK
		WHERE
			user_no = #{userNo}
			AND
			board_no = #{boardNo}
	</select>
	
	<!-- 게시글 리스트 -->	
	<select id="selectListAll" resultMap="boardList">
		SELECT 
			B.board_no, 
			B.board_no as number,
			USER.user_name, 
			CATEGORY.category_item, 
			B.category_no,
			B.board_title, 
			B.board_content_summary, 
			B.board_date, 
			B.board_view_cnt,
			(SELECT count(comment_no) FROM COMMENT WHERE COMMENT.comment_parent_no = 0 AND COMMENT.board_no = number) as comment_count,
			(SELECT count(file_no) FROM BOARD.FILE WHERE FILE.board_no = number) as file_count
		FROM (
				SELECT 
					BOARD.board_no, BOARD.user_no, BOARD.category_no, BOARD.board_title, BOARD.board_content_summary, 
					BOARD.board_date, BOARD.board_view_cnt, BOARD.board_content
				FROM BOARD
				JOIN  USER
					ON BOARD.user_no = USER.user_no
				JOIN CATEGORY
					ON BOARD.category_no = CATEGORY.category_no
				<include refid="search"></include>
				ORDER BY BOARD.board_no desc 
				LIMIT #{startBoardNo}, #{perPageNum}
		) B
		JOIN CATEGORY
			ON B.category_no = CATEGORY.category_no
		JOIN USER
			ON B.user_no = USER.user_no
		GROUP BY B.board_no
		ORDER BY B.board_no desc
	</select>
	
	<select id="selectMyQuestions" resultMap="boardList">
		SELECT 
			B.board_no,
			B.board_no as number,
			B.category_item, 
			B.category_no,
			B.board_title, 
			B.board_content_summary, 
			B.board_date, 
			B.board_view_cnt,
			(SELECT count(comment_no) FROM COMMENT WHERE COMMENT.comment_parent_no = 0 AND COMMENT.board_no = number) as comment_count,
			(SELECT count(file_no) FROM BOARD.FILE WHERE FILE.board_no = number) as file_count
		FROM (
				SELECT 
					BOARD.board_no, BOARD.user_no, BOARD.category_no, BOARD.board_title, BOARD.board_content_summary, 
					BOARD.board_date, BOARD.board_view_cnt, BOARD.board_content, CATEGORY.category_item
				FROM BOARD
				JOIN CATEGORY
					ON BOARD.category_no = CATEGORY.category_no
				WHERE BOARD.user_no = #{userNo} 
				<include refid="search2"></include>
				ORDER BY BOARD.board_no desc 
				LIMIT #{startBoardNo}, #{perPageNum}
		) B
		GROUP BY B.board_no
		ORDER BY B.board_no desc
	</select>
	
	<select id="selectMyQuestionsAnswered" resultMap="boardList">
		SELECT 
			B.board_no,
			B.board_no as number,
			CATEGORY.category_item, 
			B.category_no,
			B.board_title, 
			B.board_content_summary, 
			B.board_date, 
			B.board_view_cnt,
			B.comment_count,
			(SELECT count(file_no) FROM BOARD.FILE WHERE FILE.board_no = number) as file_count
		FROM (
				SELECT 
					BOARD.board_no, BOARD.user_no, BOARD.category_no, BOARD.board_title, BOARD.board_content_summary, 
					BOARD.board_date, BOARD.board_view_cnt, BOARD.board_content, count(COMMENT.comment_no) as comment_count
				FROM BOARD
				JOIN COMMENT
					ON BOARD.board_no = COMMENT.board_no
				WHERE BOARD.user_no = #{userNo} AND COMMENT.comment_parent_no = 0
				GROUP BY BOARD.board_no
				ORDER BY BOARD.board_no desc 
				LIMIT #{startBoardNo}, #{perPageNum}
		) B
		JOIN CATEGORY
			ON B.category_no = CATEGORY.category_no
		GROUP BY B.board_no
		ORDER BY B.board_no desc
	</select>
	
	<select id="selectMyFavorite" resultMap="boardList">
		SELECT 
			B.board_no,
			B.board_no as number, 
			USER.user_name, 
			CATEGORY.category_item, 
			B.category_no,
			B.board_title, 
			B.board_content_summary, 
			B.board_date, 
			B.board_view_cnt,
			(SELECT count(comment_no) FROM COMMENT WHERE COMMENT.comment_parent_no = 0 AND COMMENT.board_no = number) as comment_count,
			(SELECT count(file_no) FROM BOARD.FILE WHERE FILE.board_no = number) as file_count
		FROM (
				SELECT 
					BOARD.board_no, BOARD.user_no, BOARD.category_no, BOARD.board_title, BOARD.board_content_summary, 
					BOARD.board_date, BOARD.board_view_cnt, BOARD.board_content
				FROM BOARD
				JOIN BOOKMARK
					ON BOARD.board_no = BOOKMARK.board_no
				WHERE BOOKMARK.user_no = #{userNo} 
				ORDER BY BOARD.board_no desc 
				LIMIT #{startBoardNo}, #{perPageNum}
		) B
		JOIN CATEGORY
			ON B.category_no = CATEGORY.category_no
		JOIN USER
			ON B.user_no = USER.user_no
		GROUP BY B.board_no
		ORDER BY B.board_no desc
	</select>
	
	<!-- 페이징을 위한 게시글 개수 구하기 -->	
	<select id="countListAllPaging" resultType="int">
		SELECT COUNT(board_no) 
		FROM BOARD
		JOIN CATEGORY
			ON BOARD.category_no = CATEGORY.category_no
		<include refid="search"></include>
	</select>
	
	<select id="countMyQuestionsPaging" resultType="int">
		SELECT COUNT(board_no) 
		FROM BOARD
		JOIN CATEGORY
			ON BOARD.category_no = CATEGORY.category_no
		WHERE
			BOARD.user_no = #{userNo} 
		<include refid="search2"></include>
	</select>
	
	<select id="countMyQuestionsAnsweredPaging" resultType="int">
		SELECT COUNT(B.board_count) 
		FROM (
				SELECT BOARD.board_no as board_count
				FROM BOARD.BOARD
				JOIN BOARD.COMMENT
					ON BOARD.board_no = COMMENT.board_no
				WHERE BOARD.user_no = #{userNo}  
				GROUP BY BOARD.board_no
			) B
	</select>
	
	<select id="countMyFavoritePaging" resultType="int">
		SELECT COUNT(BOOKMARK.board_no) 
		FROM BOOKMARK
		WHERE
			BOOKMARK.user_no = #{userNo}
	</select>
	
	<!-- 게시글의 해당 작성자 확인 -->
	<select id="checkUser" resultType="int">
		SELECT 
			user_no 
		FROM BOARD
		WHERE 
			board_no = #{boardNo}
	</select>
	
	<!-- 조회수 증가 -->
	<update id="increaseViewCount">
		UPDATE BOARD SET 
			board_view_cnt = board_view_cnt + 1 
		WHERE 
			board_no = #{boardNo}
	</update>

	<!-- 검색 조건 -->
	<sql id="search">
		<if test="categoryType != '' ">
			WHERE
			<include refid="categoryType_search"></include>
		</if>
		<if test="searchType != '' ">
			<if test="categoryType != '' ">
				AND
			</if>
			<if test="categoryType == '' ">
				WHERE
			</if>
			<include refid="searchType_search"></include>
		</if> 
		<if test="date != '' and date != null">
			<choose>
				<when test="categoryType != '' || searchType != ''"> AND</when>
				<otherwise>WHERE</otherwise>
			</choose>
			<include refid="date_search"></include>
		</if> 
	</sql>
	
	<sql id="search2">
		<if test="categoryType != '' ">
			AND
			<include refid="categoryType_search"></include>
		</if>
		<if test="searchType != '' ">
			AND
			<include refid="searchType_search"></include>
		</if> 
		<if test="date != '' and date != null">
			AND
			<include refid="date_search"></include>
		</if> 
	</sql>

	<sql id="categoryType_search">
		CATEGORY.category_item = #{categoryType}
	</sql>
	
	<sql id="searchType_search">
		<choose>
			<when test="searchType == 'title_content'">
				( BOARD.board_content_summary like CONCAT('%',#{modifiedKeyword},'%')
				OR BOARD.board_title like CONCAT('%',#{modifiedKeyword},'%') )
			</when>
			<when test="searchType == 'content'">
				BOARD.board_content_summary like CONCAT('%',#{modifiedKeyword},'%')
			</when>
			<when test="searchType == 'title'">
				BOARD.board_content_summary like CONCAT('%',#{modifiedKeyword},'%') 
			</when>
			<when test="searchType == 'writer'">
				USER.user_id = #{modifiedKeyword}
			</when>
		</choose>
	</sql>
	
	<sql id="date_search">
		DATE(BOARD.board_date) = #{date}
	</sql>
</mapper>
